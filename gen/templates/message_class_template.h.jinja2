
// AUTO GENERATED. DO NOT EDIT.
//
#pragma once
#include <cstdint>
#include <array>
#include <string_view>

#include "gendb/message_base.h"
#include "gendb/message_builder.h"
#include "gendb/bits.h"
#include "gendb/message_patch.h"

// Enum definitions
{% for enum in enums.values() %}
{% if enum.namespace %}namespace {{ enum.namespace.replace('.', '::') }} {
{% endif %}
enum class {{ enum.name }} : {{ enum.underlying_type }} {
  {% for value_name, value in enum.vals %}
  {{ value_name }} = {{ value }},
  {% endfor %}
};
{% if enum.namespace %}
} // namespace {{ enum.namespace.replace('.', '::') }}
{% endif %}
{% endfor %}

// Message classes
{% for table in tables %}
{% if table.namespace %}namespace {{ table.namespace }} {
{% endif %}
// GeneratedClass
class {{ table.name }} : private gendb::MessageBase {
 public:

  enum Field : int {
    {% for field in table.fields %}
    {{ field.name | pascalcase }} = {{ loop.index }},
    {% endfor %}
    MaxFields
  };

  static constexpr std::array<uint32_t, {{ table.K }}> kFixedSizeFields = gendb::MakeConstexprFieldBitmask<{{ table.K }}>({
    {% for field in table.fixed_fields %}
      {{ field.name | pascalcase }},
    {% endfor %}
  });

  {{ table.name }}() = default;
  {{ table.name }}(std::span<const uint8_t> span) : MessageBase(span) {}

  {% for field in table.fields %}
  bool has_{{ field.name | snakecase }}() const { return HasField({{ field.name | pascalcase }}); }
  {% if field.cpp_type == 'std::string' %}
  std::string_view {{ field.name | snakecase }}() const { return ReadStringField({{ field.name | pascalcase }}, ""); }
  {% elif field.is_enum %}
  {{ field.cpp_type }} {{ field.name | snakecase }}() const { return static_cast<{{ field.cpp_type }}>(ReadScalarField<{{ enums[field.enum_type].underlying_type }}>({{ field.name | pascalcase }}, {{ field.default }})); }
  {% else %}
  {{ field.cpp_type }} {{ field.name | snakecase }}() const { return ReadScalarField<{{ field.cpp_type }}>({{ field.name | pascalcase }}, {{ field.default }}); }
  {% endif %}
  {% endfor %}


  // MessageBase methods.
  using gendb::MessageBase::FieldCount;
  using gendb::MessageBase::HasField;
  using gendb::MessageBase::GetFieldsMask;
  std::span<const uint8_t> FieldRaw(int field_id) const {
    return gendb::MessageBase::FieldRaw(field_id);
  }

  friend class {{ table.name | pascalcase }}Builder;
};

class {{ table.name | pascalcase }}Builder : public gendb::MessageBuilder {
 public:
  {{ table.name | pascalcase }}Builder() : MessageBuilder() {}
  {{ table.name | pascalcase }}Builder({{ table.name }}& obj) : MessageBuilder(obj) {}

  {% for field in table.fields %}
  {% if field.cpp_type == 'std::string' %}
  void set_{{ field.name | snakecase }}(std::string_view value) { AddStringField({{ table.name }}::{{ field.name | pascalcase }}, value); }
  {% elif field.is_enum %}
  void set_{{ field.name | snakecase }}({{ field.cpp_type }} value) { AddField<{{ enums[field.enum_type].underlying_type }}>({{ table.name }}::{{ field.name | pascalcase }}, static_cast<{{ enums[field.enum_type].underlying_type }}>(value)); }
  {% else %}
  void set_{{ field.name | snakecase }}({{ field.const_ref_type }} value) { AddField<{{ field.cpp_type }}>({{ table.name }}::{{ field.name | pascalcase }}, value); }
  {% endif %}
  {% endfor %}

  {% for field in table.fields %}
  void clear_{{ field.name | snakecase }}() { ClearField({{ table.name }}::{{ field.name | pascalcase }}); }
  {% endfor %}

  std::vector<uint8_t> Build() { return MessageBuilder::Build(); }
};

class {{ table.name | pascalcase }}PatchBuilder {
 public:
  {{ table.name | pascalcase }}PatchBuilder() = default;
  // TODO: Add constructor with primary key fields.

  {% for field in table.fields %}
  {{ table.name | pascalcase }}PatchBuilder&& set_{{ field.name | snakecase }}({{ field.const_ref_type }} value) && {
    _builder.set_{{ field.name | snakecase }}(value);
    SetFieldBit(modified, {{ table.name }}::{{ field.name | pascalcase }});
    UnsetFieldBit(removed, {{ table.name }}::{{ field.name | pascalcase }});
    return std::move(*this);
  }
  {{ table.name | pascalcase }}PatchBuilder&& clear_{{ field.name | snakecase }}() && {
    SetFieldBit(removed, {{ table.name }}::{{ field.name | pascalcase }});
    UnsetFieldBit(modified, {{ table.name }}::{{ field.name | pascalcase }});
    _builder.clear_{{ field.name | snakecase }}();
    return std::move(*this);
  }
  {% endfor %}

  gendb::MessagePatch BuildPatch() && {
    gendb::MessagePatch patch;
    patch.modified = std::move(modified);
    patch.removed = std::move(removed);
    patch.buffer = _builder.Build();
    return patch;
  }

 private:
  gendb::Bitmask modified;
  gendb::Bitmask removed;
  {{ table.name | pascalcase }}Builder _builder;
};
{% if table.namespace %}
} // namespace {{ table.namespace }}
{% endif %}
{% endfor %}
